<!DOCTYPE html>
<html lang="en">
 <head>
   <meta charset="utf-8" />
   <meta http-equiv="x-ua-compatible" content="ie=edge" />
   <meta name="viewport" content="width=device-width, initial-scale=1" />


   <title>Test Auth Server</title>
 </head>


 <body>
   <style>
     #container {
       max-width: 500px;
     }
     h4 {
       margin-top: 25px;
     }
   </style>


   <main id="container">
     <h1>OAuth2 Test</h1>
     <h4><b>Step 1:</b> Get the OAuth URL</h4>
     <p>Click the button below to get your OAuth URL.</p>
     <button id="getAuthUrlButton">Get OAuth URL</button>
     <p id="result"></p>
     <a id="authURL" href target="_blank">Click to authorize</a>
     <!-- STEP 2 -- MAKE SURE STEP 1 WORKS BEFORE MOVING ON-->


     <h4>Step 2: Get your code and exchange for an access token</h4>
     <p>
       After youâ€™re redirected back to your Meet app on GitHub, copy the code
       from the URI.
     </p>
     <br />
     <label
       >Code input
       <input id="code" type="text" value="" />
     </label>
     <button id="getToken">Get Token</button>
     <p id="accessToken"></p>
     <!--Step 3 -- Make sure step 2 works before moving on-->
     <h4>Step 3: Get the calendar events using your access token</h4>
    <button id="getEvents">Get Events</button>
    <p id="events"></p> 
   </main>
   <!--New line of Code for Script starts here-->
   <script type="text/javascript">
     // --------------------- STEP 1
    const getAuthUrlButton = document.getElementById("get-auth-url-button");
    const getAuthUrlResult = document.getElementById("result-paragraph");
    const authLink = document.getElementById("auth-link");
    const getTokenButton = document.getElementById("get-token-button");
    const getEventsButton = document.getElementById("get-events-button");
    const codeInput = document.getElementById("code-input");

    // Replace this with your actual API endpoint for getAuthUrl
    const getAuthUrlEndpoint =
      "https://ca7b4oky1j.execute-api.eu-central-1.amazonaws.com/dev/api/get-auth-url";

    // Replace this with your actual API endpoint for getAccessToken
    const getAccessTokenEndpoint =
      "https://ca7b4oky1j.execute-api.eu-central-1.amazonaws.com/dev/api/token/{code}";

    getAuthUrlButton.addEventListener("click", () => {
      fetch(getAuthUrlEndpoint)
        .then((response) => response.json())
        .then((data) => {
          authLink.href = data.authUrl;
          authLink.style.display = "block";
          getAuthUrlResult.textContent = "";
        })
        .catch(() => {
          getAuthUrlResult.textContent = "Oops. Something went wrong.";
        });
    });

    getTokenButton.addEventListener("click", () => {
      const code = codeInput.value;
      if (code) {
        // Construct the correct endpoint URL without the '{code}' placeholder
        const endpoint = getAccessTokenEndpoint.replace("{code}", "");
        
        // This is the critical change: Use a POST request and send the code in the body
        fetch(endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ code: code }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Access token received:", data.accessToken);
            console.log("Refresh token received:", data.refreshToken);
            // We're not doing anything with these tokens on the front end yet,
            // but in a real app, you would save them here.
            alert("Tokens received. Check the Lambda logs!");
          })
          .catch((error) => {
            console.error("Error exchanging code for token:", error);
            alert("Error: " + error.message);
          });
      } else {
        alert("Please paste the authorization code into the input field.");
      }
    });

    // You will implement this later
    getEventsButton.addEventListener("click", () => {
      alert("This functionality is not yet implemented.");
    });
      // -- END OF STEP 3

   </script>
 </body>
</html>