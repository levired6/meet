<!DOCTYPE html>
<html lang="en">
 <head>
   <meta charset="utf-8" />
   <meta http-equiv="x-ua-compatible" content="ie=edge" />
   <meta name="viewport" content="width=device-width, initial-scale=1" />

   <title>Test Auth Server</title>
 </head>

 <body>
   <style>
     #container {
       max-width: 500px;
     }
     h4 {
       margin-top: 25px;
     }
   </style>

   <main id="container">
     <h1>OAuth2 Test</h1>
     <h4><b>Step 1:</b> Get the OAuth URL</h4>
     <p>Click the button below to get your OAuth URL.</p>
     <button id="getAuthUrlButton">Get OAuth URL</button>
     <p id="result"></p>
     <a id="authURL" href target="_blank" style="display: none;">Click to authorize</a>
     <!-- STEP 2 -- MAKE SURE STEP 1 WORKS BEFORE MOVING ON-->

     <h4>Step 2: Get your code and exchange for an access token</h4>
     <p>
       After youâ€™re redirected back to your Meet app on GitHub, copy the code
       from the URI.
     </p>
     <br />
     <label>
       Code input
       <input id="code" type="text" value="" />
     </label>
     <button id="getToken">Get Token</button>
     <p id="accessToken"></p>
     <!--Step 3 -- Make sure step 2 works before moving on-->
     <h4>Step 3: Get the calendar events using your access token</h4>
    <button id="getEvents">Get Events</button>
    <p id="events"></p>
    </main>
   <!--New line of Code for Script starts here-->
   <script type="text/javascript">
     // --------------------- STEP 1
     const getAuthUrlButton = document.getElementById("getAuthUrlButton");
     const resultElement = document.getElementById("result");
     const resultLink = document.getElementById("authURL");

     // IMPORTANT: Replace this with your own deployed endpoint
     const getAuthURL = "https://ca7b4oky1j.execute-api.eu-central-1.amazonaws.com/dev/api/get-auth-url";

     getAuthUrlButton.addEventListener("click", () => {
       fetch(getAuthURL)
         .then(response => response.json())
         .then(json => {
           const { authUrl } = json;
           resultElement.innerText = `Authorization URL: ${authUrl}`;
           resultLink.href = authUrl;
           resultLink.style.display = 'block';
         })
         .catch(error => {
           resultElement.innerText = `Error: ${error.message}`;
         });
     });

     // --------------------- END OF STEP 1

     // --------------------- STEP 2
     const codeValue = document.getElementById("code");
     const getAccessTokenButton = document.getElementById("getToken");
     const accessTokenElement = document.getElementById("accessToken");

     // IMPORTANT: Replace this with your own deployed endpoint
     const getTokenEndpoint = "https://ca7b4okylj.execute-api.eu-central-1.amazonaws.com/dev/api/token";

     getAccessTokenButton.addEventListener("click", () => {
       const code = codeValue.value;

       if (!code) {
         accessTokenElement.innerText = "Please paste the authorization code.";
         return;
       }

       fetch(getTokenEndpoint, {
         method: "POST",
         headers: {
           "Content-Type": "application/json",
         },
         body: JSON.stringify({ code: code }),
       })
         .then(response => response.json())
         .then(json => {
           accessTokenElement.innerText = JSON.stringify(json, null, 2);
         })
         .catch(error => {
           accessTokenElement.innerText = `Error: ${error.message}`;
         });
     });
     // --------------------- END OF STEP 2
      // -- STEP 3
      const getEventsButton = document.getElementById("getEvents");
      const eventsElement = document.getElementById("events");

      // IMPORTANT: Replace this with your own deployed endpoint
      const getCalendarEventsEndpoint = "https://ca7b4okylj.execute-api.eu-central-1.amazonaws.com/dev/api/get-events";

      getEventsButton.addEventListener("click", () => {
        try {
          const { access_token, refresh_token } = JSON.parse(accessTokenElement.innerText);
          const eventRequest = `${getCalendarEventsEndpoint}?accessToken=${access_token}&refreshToken=${refresh_token}`;

          fetch(eventRequest)
            .then(response => response.json())
            .then(json => {
              eventsElement.innerText = JSON.stringify(json, null, 2);
            })
            .catch(error => {
              eventsElement.innerText = `Error fetching events: ${error.message}`;
            });
        } catch (error) {
          eventsElement.innerText = "Please get a valid access token first.";
        }
      });
      // -- END OF STEP 3
   </script>
 </body>
</html>